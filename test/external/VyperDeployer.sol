// SPDX-License-Identifier: UNLICENSED
pragma solidity >=0.8.13;

//Taken from: https://github.com/0xKitsune/Foundry-Vyper

///@notice This cheat codes interface is named _CheatCodes so you can use the CheatCodes interface in other testing files without errors
interface _CheatCodes {
    function ffi(string[] calldata) external returns (bytes memory);
}

contract VyperDeployer {
    address constant HEVM_ADDRESS = address(bytes20(uint160(uint256(keccak256("hevm cheat code")))));

    /// @notice Initializes cheat codes in order to use ffi to compile Vyper contracts
    _CheatCodes cheatCodes = _CheatCodes(HEVM_ADDRESS);

    ///@notice Compiles a Vyper contract and returns the address that the contract was deployeod to
    ///@notice If deployment fails, an error will be thrown
    ///@param fileName - The file name of the Vyper contract. For example, the file name for "SimpleStore.vy" is "SimpleStore"
    ///@return deployedAddress - The address that the contract was deployed to

    function deployContract(string memory fileName) public returns (address) {
        ///@notice create a list of strings with the commands necessary to compile Vyper contracts
        string[] memory cmds = new string[](2);
        cmds[0] = "vyper";
        cmds[1] = string.concat("test/external/", fileName, ".vy");

        ///@notice compile the Vyper contract and return the bytecode
        bytes memory bytecode = cheatCodes.ffi(cmds);

        ///@notice deploy the bytecode with the create instruction
        address deployedAddress;
        assembly {
            deployedAddress := create(0, add(bytecode, 0x20), mload(bytecode))
        }

        ///@notice check that the deployment was successful
        require(deployedAddress != address(0), "VyperDeployer could not deploy contract");

        ///@notice return the address that the contract was deployed to
        return deployedAddress;
    }

    ///@notice Compiles a Vyper contract with constructor arguments and returns the address that the contract was deployeod to
    ///@notice If deployment fails, an error will be thrown
    ///@param fileName - The file name of the Vyper contract. For example, the file name for "SimpleStore.vy" is "SimpleStore"
    ///@return deployedAddress - The address that the contract was deployed to
    function deployContract(string memory fileName, bytes calldata args) public returns (address) {
        ///@notice create a list of strings with the commands necessary to compile Vyper contracts
        string[] memory cmds = new string[](2);
        cmds[0] = "vyper";
        cmds[1] = string.concat("test/external/", fileName, ".vy");

        ///@notice compile the Vyper contract and return the bytecode
        bytes
            memory _bytecode = hex"61269656600436101561000d576116d1565b60046000601c376f7fffffffffffffffffffffffffffffff6040526000513461268d576383b4358981141561021c576004358060a01c61268d57809050610140526024358060a01c61268d57809050610160526044358060a01c61268d5780905061018052606435600401604081351161268d5780803560200180826101a037505050608435600401602081351161268d578080356020018082610200375050506c050c783eb9b5c84000000000165461268d5760016c050c783eb9b5c840000000001655600061014051181561268d57610140516c050c783eb9b5c84000000000145561016051600555610180516c050c783eb9b5c84000000000135543600c5542600b5563313ce567610260526020610260600461027c610160515afa1561268d57601f3d111561268d57610260516102405260ff610240511161268d57610240516c050c783eb9b5c8400000000011556101a0806c050c783eb9b5c840000000000c602082510161012060006003818352015b82610120516020021115610196576101b7565b61012051602002850151610120518501558151600101808352811415610183575b505050505050610200806c050c783eb9b5c840000000000f602082510161012060006002818352015b826101205160200211156101f357610214565b610120516020028501516101205185015581516001018083528114156101e0575b505050505050005b636b441a408114156102a0576004358060a01c61268d57809050610140526c050c783eb9b5c84000000000145433141561268d57600061014051181561268d57610140516c050c783eb9b5c8400000000015557f2f56810a6bf40af059b96d3aea4db54081f378029a518390491093a7b67032e961014051610160526020610160a1005b63e5ea47b881141561030e576c050c783eb9b5c840000000001554610140526101405133141561268d57610140516c050c783eb9b5c8400000000014557febee2d5739011062cb4f14113f3b36bf0ffe3da5c0568f64189d1012a118910561014051610160526020610160a1005b636a1c05ae811415610393576c050c783eb9b5c84000000000145433141561268d576c050c783eb9b5c84000000000155461014052600061014051181561268d57610140516c050c783eb9b5c8400000000014557febee2d5739011062cb4f14113f3b36bf0ffe3da5c0568f64189d1012a118910561014051610160526020610160a1005b6357f901e28114156103dc576004358060a01c61268d57809050610140526c050c783eb9b5c84000000000145433141561268d57610140516c050c783eb9b5c840000000001255005b638e5b490f81141561041e576c050c783eb9b5c84000000000145433141561268d576c050c783eb9b5c8400000000012546c050c783eb9b5c840000000001355005b637c74a17481141561049e576004358060a01c61268d57809050610140526c050c783eb9b5c840000000000a6101405160e05260c052604060c02054610160526001600461016051633b9aca0081101561268d57026c050c783eb9b5c84000000000096101405160e05260c052604060c020010154610180526020610180f35b63da020a188114156104fb576004358060a01c61268d578090506101405260026004602435633b9aca0081101561268d57026c050c783eb9b5c84000000000096101405160e05260c052604060c020010154610160526020610160f35b63adc63589811415610539576004358060a01c61268d5780905061014052600160076101405160e05260c052604060c0200154610160526020610160f35b63c2c4c5c181141561056357600061014052604036610160376040366101a0376105616117ae565b005b633a46273e8114156106cd576004358060a01c61268d578090506106e05260005461268d57600160005560076106e05160e05260c052604060c020805461070052600181015461072052506000602435111561268d5760006107005113610609576308c379a0610740526020610760526016610780527f4e6f206578697374696e67206c6f636b20666f756e64000000000000000000006107a05261078050606461075cfd5b42610720511161067d576308c379a0610740526020610760526024610780527f43616e6e6f742061646420746f2065787069726564206c6f636b2e20576974686107a0527f64726177000000000000000000000000000000000000000000000000000000006107c05261078050608461075cfd5b6106e0516104e0526024356105005260006105205260076106e05160e05260c052604060c02080546105405260018101546105605250600061058052336105a0526106c6611ef5565b6000600055005b6365fc38738114156108ad5760015461268d57600160015533610140526106f26116d7565b60243562093a808082049050905062093a8080820282158284830414171561268d57809050905090506106e05260073360e05260c052604060c020805461070052600181015461072052506000600435111561268d576107005115610796576308c379a0610740526020610760526019610780527f5769746864726177206f6c6420746f6b656e73206669727374000000000000006107a05261078050606461075cfd5b426106e0511161080a576308c379a0610740526020610760526026610780527f43616e206f6e6c79206c6f636b20756e74696c2074696d6520696e20746865206107a0527f66757475726500000000000000000000000000000000000000000000000000006107c05261078050608461075cfd5b42630784ce00818183011061268d57808201905090506106e051111561086f576308c379a061074052602061076052601e610780527f566f74696e67206c6f636b2063616e2062652034207965617273206d617800006107a05261078050606461075cfd5b336104e052600435610500526106e0516105205261070051610540526107205161056052600161058052336105a0526108a6611ef5565b6000600155005b634957677c8114156109fb5760025461268d57600160025533610140526108d26116d7565b60073360e05260c052604060c02080546106e052600181015461070052506000600435111561268d5760006106e0511361094b576308c379a0610720526020610740526016610760527f4e6f206578697374696e67206c6f636b20666f756e64000000000000000000006107805261076050606461073cfd5b4261070051116109bf576308c379a0610720526020610740526024610760527f43616e6e6f742061646420746f2065787069726564206c6f636b2e2057697468610780527f64726177000000000000000000000000000000000000000000000000000000006107a05261076050608461073cfd5b336104e052600435610500526000610520526106e051610540526107005161056052600261058052336105a0526109f4611ef5565b6000600255005b63eff7a612811415610bfe5760035461268d5760016003553361014052610a206116d7565b60073360e05260c052604060c02080546106e0526001810154610700525060043562093a808082049050905062093a8080820282158284830414171561268d578090509050905061072052426107005111610aba576308c379a061074052602061076052600c610780527f4c6f636b206578706972656400000000000000000000000000000000000000006107a05261078050606461075cfd5b60006106e05113610b0a576308c379a0610740526020610760526011610780527f4e6f7468696e67206973206c6f636b65640000000000000000000000000000006107a05261078050606461075cfd5b610700516107205111610b5c576308c379a061074052602061076052601f610780527f43616e206f6e6c7920696e637265617365206c6f636b206475726174696f6e006107a05261078050606461075cfd5b42630784ce00818183011061268d5780820190509050610720511115610bc1576308c379a061074052602061076052601e610780527f566f74696e67206c6f636b2063616e2062652034207965617273206d617800006107a05261078050606461075cfd5b336104e05260006105005261072051610520526106e051610540526107005161056052600361058052336105a052610bf7611ef5565b6000600355005b633ccfd60b811415610dde5760045461268d57600160045560073360e05260c052604060c02080546104e0526001810154610500525061050051421015610c84576308c379a0610520526020610540526016610560527f546865206c6f636b206469646e277420657870697265000000000000000000006105805261056050606461053cfd5b6104e0516000811261268d57610520526104e05161054052610500516105605260006105005260006104e05260073360e05260c052604060c0206104e05181556105005160018201555060065461058052610580516105205180821061268d57808203905090506006553361014052610540516101605261056051610180526104e0516101a052610500516101c052610d1b6117ae565b63a9059cbb6105a052336105c052610520516105e05260206105a060446105bc60006005545af11561268d57601f3d111561268d576105a0511561268d57337ff279e6a1f5e320cca91135676d9cb6e44ca8a08c0b88342bcdb1144f6511b568610520516105a052426105c05260406105a0a27f5e2aa66efd74cce82b21852e317e5490d9ecc9e6bb953ae24d90851258cc2f5c610580516105a052610580516105205180821061268d57808203905090506105c05260406105a0a16000600455005b6370a08231811415610df4574261016052610e07565b62fdd58e811415610f3557602435610160525b6004358060a01c61268d57809050610140526c050c783eb9b5c840000000000a6101405160e05260c052604060c020546101805261018051610e575760006101a05260206101a0610f3356610f32565b600461018051633b9aca0081101561268d57026c050c783eb9b5c84000000000096101405160e05260c052604060c0200180546101a05260018101546101c05260028101546101e052600381015461020052506101a080516101c051610160516101e05180821061268d5780820390509050604051811161268d5780820280607f1d8160801d141561268d578090509050905080820380607f1d8160801d141561268d578090509050905081525060006101a0511215610f185760006101a0525b6101a0516000811261268d57610220526020610220610f33565b5bf35b634ee2cd7e811415610f7c576004358060a01c61268d5780905061048052610480516102005260243561022052610f6d6104a061217e565b6104a0516104c05260206104c0f35b633a46b1a8811415610fc3576004358060a01c61268d5780905061048052610480516102005260243561022052610fb46104a061217e565b6104a0516104c05260206104c0f35b6318160ddd811415610fd957426102c052610fed565b63bd85b039811415611077576004356102c0525b6008546102e05260046102e0516c01431e0fae6d7217caa000000081101561268d570260090180546103005260018101546103205260028101546103405260038101546103605250610300516101405261032051610160526103405161018052610360516101a0526102c0516101c052611068610380612503565b610380516103a05260206103a0f35b63981b24d08114156112a057436004351161268d576008546102c052600435610140526102c051610160526110ad6103006120ae565b610300516102e05260046102e0516c01431e0fae6d7217caa000000081101561268d5702600901805461030052600181015461032052600281015461034052600381015461036052506000610380526102c0516102e05110156111da5760046102e0516001818183011061268d57808201905090506c01431e0fae6d7217caa000000081101561268d570260090180546103a05260018101546103c05260028101546103e05260038101546104005250610400516103605118156111d5576004356103605180821061268d57808203905090506103e0516103405180821061268d578082039050905080820282158284830414171561268d5780905090509050610400516103605180821061268d578082039050905080801561268d57820490509050610380525b61124a565b43610360511815611249576004356103605180821061268d5780820390509050426103405180821061268d578082039050905080820282158284830414171561268d5780905090509050436103605180821061268d578082039050905080801561268d57820490509050610380525b5b610300516101405261032051610160526103405161018052610360516101a0526103405161038051818183011061268d57808201905090506101c0526112916103a0612503565b6103a0516103c05260206103c0f35b63fc0c546a8114156112ba57600554610140526020610140f35b63047fc9aa8114156112d457600654610140526020610140f35b63cbf9fe5f81141561131a576004358060a01c61268d578090506101405260076101405160e05260c052604060c020805461016052600181015461018052506040610160f35b63900cf0cf81141561133457600854610140526020610140f35b63d1febfb98114156113875760046004356c01431e0fae6d7217caa000000081101561268d570260090180546101405260018101546101605260028101546101805260038101546101a052506080610140f35b6328d09d478114156113fe576004358060a01c61268d57809050610140526004602435633b9aca0081101561268d57026c050c783eb9b5c84000000000096101405160e05260c052604060c0200180546101605260018101546101805260028101546101a05260038101546101c052506080610160f35b63010ae757811415611445576004358060a01c61268d57809050610140526c050c783eb9b5c840000000000a6101405160e05260c052604060c02054610160526020610160f35b6371197484811415611479576c050c783eb9b5c840000000000b60043560e05260c052604060c02054610140526020610140f35b6306fdde0381141561153257610140806020808252808301806c050c783eb9b5c840000000000c8082602082540161012060006003818352015b826101205160200211156114c6576114e7565b610120518501546101205160200285015281516001018083528114156114b3575b5050505050508051806020830101818260206001820306601f8201039050033682375050805160200160206001820306601f8201039050905090508101905080905090509050610140f35b6395d89b418114156115eb57610140806020808252808301806c050c783eb9b5c840000000000f8082602082540161012060006002818352015b8261012051602002111561157f576115a0565b6101205185015461012051602002850152815160010180835281141561156c575b5050505050508051806020830101818260206001820306601f8201039050033682375050805160200160206001820306601f8201039050905090508101905080905090509050610140f35b63313ce567811415611611576c050c783eb9b5c840000000001154610140526020610140f35b638ff36fd1811415611637576c050c783eb9b5c840000000001254610140526020610140f35b637175d4f781141561165d576c050c783eb9b5c840000000001354610140526020610140f35b63f851a440811415611683576c050c783eb9b5c840000000001454610140526020610140f35b6317f7182a8114156116a9576c050c783eb9b5c840000000001554610140526020610140f35b63158ef93e8114156116cf576c050c783eb9b5c840000000001654610140526020610140f35b505b60006000fd5b326101405118156117ab576c050c783eb9b5c8400000000013546101605260006101605118156117415763c23697a861018052610140516101a0526020610180602461019c6000610160515af11561268d57601f3d111561268d576101805115611740576117ac565b5b6308c379a06101805260206101a05260256101c0527f536d61727420636f6e7472616374206465706f7369746f7273206e6f7420616c6101e0527f6c6f776564000000000000000000000000000000000000000000000000000000610200526101c050608461019cfd5b5b565b610140366101e03760085461032052600061014051181561193957426101805111156117e057600061016051136117e3565b60005b1561184a5761016051630784ce0080820580607f1d8160801d141561268d57809050905090506102005261020051610180514280821061268d5780820390509050604051811161268d5780820280607f1d8160801d141561268d57809050905090506101e0525b426101c05111156118615760006101a05113611864565b60005b156118cb576101a051630784ce0080820580607f1d8160801d141561268d578090509050905061028052610280516101c0514280821061268d5780820390509050604051811161268d5780820280607f1d8160801d141561268d5780905090509050610260525b6c050c783eb9b5c840000000000b6101805160e05260c052604060c020546102e05260006101c051181561193857610180516101c0511415611914576102e05161030052611937565b6c050c783eb9b5c840000000000b6101c05160e05260c052604060c02054610300525b5b5b604036610340374261038052436103a0526000610320511115611998576004610320516c01431e0fae6d7217caa000000081101561268d570260090180546103405260018101546103605260028101546103805260038101546103a052505b610380516103c052610340516103e052610360516104005261038051610420526103a0516104405260006104605261038051421115611a2957670de0b6b3a7640000436103a05180821061268d578082039050905080820282158284830414171561268d5780905090509050426103805180821061268d578082039050905080801561268d57820490509050610460525b6103c05162093a808082049050905062093a8080820282158284830414171561268d5780905090509050610480526104a0600060ff818352015b610480805162093a80818183011061268d578082019050905081525060006104c05242610480511115611a9a574261048052611abd565b6c050c783eb9b5c840000000000b6104805160e05260c052604060c020546104c0525b610340805161036051610480516103c05180821061268d5780820390509050604051811161268d5780820280607f1d8160801d141561268d578090509050905080820380607f1d8160801d141561268d578090509050905081525061036080516104c05180820180607f1d8160801d141561268d57809050905090508152506000610340511215611b4f576000610340525b6000610360511215611b62576000610360525b610480516103c05261048051610380526104405161046051610480516104205180821061268d578082039050905080820282158284830414171561268d5780905090509050670de0b6b3a764000080820490509050818183011061268d57808201905090506103a05261032080516001818183011061268d578082019050905081525042610480511415611bfe57436103a052611c5056611c40565b6004610320516c01431e0fae6d7217caa000000081101561268d57026009016103405181556103605160018201556103805160028201556103a0516003820155505b8151600101808352811415611a63575b5050610320516008556000610140511815611d0c576103608051610280516102005180820380607f1d8160801d141561268d578090509050905080820180607f1d8160801d141561268d57809050905090508152506103408051610260516101e05180820380607f1d8160801d141561268d578090509050905080820180607f1d8160801d141561268d57809050905090508152506000610360511215611cf8576000610360525b6000610340511215611d0b576000610340525b5b6004610320516c01431e0fae6d7217caa000000081101561268d57026009016103405181556103605160018201556103805160028201556103a0516003820155506000610140511815611ef35742610180511115611dde576102e080516102005180820180607f1d8160801d141561268d5780905090509050815250610180516101c0511415611dbb576102e080516102805180820380607f1d8160801d141561268d57809050905090508152505b6102e0516c050c783eb9b5c840000000000b6101805160e05260c052604060c020555b426101c0511115611e3f57610180516101c0511115611e3e5761030080516102805180820380607f1d8160801d141561268d5780905090509050815250610300516c050c783eb9b5c840000000000b6101c05160e05260c052604060c020555b5b6c050c783eb9b5c840000000000a6101405160e05260c052604060c020546001818183011061268d57808201905090506104a0526104a0516c050c783eb9b5c840000000000a6101405160e05260c052604060c02055426102a052436102c05260046104a051633b9aca0081101561268d57026c050c783eb9b5c84000000000096101405160e05260c052604060c020016102605181556102805160018201556102a05160028201556102c0516003820155505b565b610540516105c052610560516105e052600654610600526106005161050051818183011061268d57808201905090506006556105c051610620526105e051610640526105c0805161050051604051811161268d5780820180607f1d8160801d141561268d57809050905090508152506000610520511815611f7957610520516105e0525b60076104e05160e05260c052604060c0206105c05181556105e0516001820155506104e05161014052610620516101605261064051610180526105c0516101a0526105e0516101c052611fca6117ae565b600061050051181561201d576323b872dd610660526105a05161068052306106a052610500516106c0526020610660606461067c60006005545af11561268d57601f3d111561268d57610660511561268d575b6105e0516104e0517f4566dfc29f6f11d13a418c26a02bef7c28bae749d4de47e4e6a7cddea6730d5961050051610660526105805161068052426106a0526060610660a37f5e2aa66efd74cce82b21852e317e5490d9ecc9e6bb953ae24d90851258cc2f5c61060051610660526106005161050051818183011061268d5780820190509050610680526040610660a1565b600061018052610160516101a0526101c060006080818352015b6101a05161018051106120da57612173565b610180516101a051818183011061268d57808201905090506001818183011061268d57808201905090506002808204905090506101e05261014051600360046101e0516c01431e0fae6d7217caa000000081101561268d570260090101541161214a576101e05161018052612163565b6101e051600180821061268d57808203905090506101a0525b81516001018083528114156120c8575b505061018051815250565b43610220511161268d576000610240526c050c783eb9b5c840000000000a6102005160e05260c052604060c020546102605261028060006080818352015b6102605161024051106121ce57612279565b6102405161026051818183011061268d57808201905090506001818183011061268d57808201905090506002808204905090506102a05261022051600360046102a051633b9aca0081101561268d57026c050c783eb9b5c84000000000096102005160e05260c052604060c02001015411612250576102a05161024052612269565b6102a051600180821061268d5780820390509050610260525b81516001018083528114156121bc575b5050600461024051633b9aca0081101561268d57026c050c783eb9b5c84000000000096102005160e05260c052604060c0200180546102805260018101546102a05260028101546102c05260038101546102e0525060085461030052610220516101405261030051610160526122f06103406120ae565b61034051610320526004610320516c01431e0fae6d7217caa000000081101561268d570260090180546103405260018101546103605260028101546103805260038101546103a052506040366103c037610300516103205110156123da576004610320516001818183011061268d57808201905090506c01431e0fae6d7217caa000000081101561268d570260090180546104005260018101546104205260028101546104405260038101546104605250610460516103a05180821061268d57808203905090506103c052610440516103805180821061268d57808203905090506103e052612409565b436103a05180821061268d57808203905090506103c052426103805180821061268d57808203905090506103e0525b610380516104005260006103c05118156124785761040080516103e051610220516103a05180821061268d578082039050905080820282158284830414171561268d57809050905090506103c05180801561268d57820490509050818183011061268d57808201905090508152505b61028080516102a051610400516102c05180821061268d5780820390509050604051811161268d5780820280607f1d8160801d141561268d578090509050905080820380607f1d8160801d141561268d5780905090509050815250600061028051126124f657610280516000811261268d5781525061250156612500565b6000815250612501565b5b565b610140516101e052610160516102005261018051610220526101a051610240526102205162093a808082049050905062093a8080820282158284830414171561268d578090509050905061026052610280600060ff818352015b610260805162093a80818183011061268d578082019050905081525060006102a0526101c05161026051111561259a576101c051610260526125bd565b6c050c783eb9b5c840000000000b6102605160e05260c052604060c020546102a0525b6101e0805161020051610260516102205180821061268d5780820390509050604051811161268d5780820280607f1d8160801d141561268d578090509050905080820380607f1d8160801d141561268d57809050905090508152506101c05161026051141561262b57612667565b61020080516102a05180820180607f1d8160801d141561268d57809050905090508152506102605161022052815160010180835281141561255d575b505060006101e051121561267c5760006101e0525b6101e0516000811261268d57815250565b600080fd5b61000461269603610004600039610004612696036000f3";

        //add args to the deployment bytecode
        bytes memory bytecode = abi.encodePacked(_bytecode, args);

        ///@notice deploy the bytecode with the create instruction
        address deployedAddress;
        assembly {
            deployedAddress := create(0, add(bytecode, 0x20), mload(bytecode))
        }

        ///@notice check that the deployment was successful
        require(deployedAddress != address(0), "VyperDeployer could not deploy contract");

        ///@notice return the address that the contract was deployed to
        return deployedAddress;
    }
}
